<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Assignment 2 - Jung hoon</title>
    <script src="https://d3js.org/d3.v5.js"></script>
    <style>
        select{display: block;}
    </style>
</head>
<body>
    <div id="plot">
        <select class="years"></select>
        <select class="win_diff">
            <option id="WR">WR</option>
            <option id="DG">DG</option>
        </select>
        <select class="WDL">
            <option id="W">W</option>
            <option id="D">D</option>
            <option id="L">L</option>
        </select>
    </div>

    <script>
        let svgWidth = 450;
        let svgHeight = 400;
        let tableRectWidth = 60;
        let tableRectHeight = 30;
        let margin = {top: 40, right: 10, bottom: 30, left: 20};
        let width = svgWidth - margin.left - margin.right;
        let height = svgHeight - margin.top - margin.bottom;
    </script>

    <script>
    // Common functions
    function translate(X, Y){
        return 'translate(' + X + ', ' + Y + ')';
    }   

    function getSelectedData(data, year) {
        for (var i = 0; i < data.length; i++) {
            var currentData = data[i];
            if (currentData.year === year) {
                return currentData;
            } 
        }
    }

    // SVG
    let table = d3.select('#plot')
            .append('svg')
            .attr('id', 'table')
            .attr('width', svgWidth)
            .attr('height', svgHeight)
                    
    let lineSVG = d3.select('#plot')
                    .append('svg')
                    .attr('id', 'line')
                    .attr('width', svgWidth)
                    .attr('height', svgHeight)
                    .attr('transform', translate(margin.left, margin.top));
    
    let barSVG = d3.select('#plot')
                    .append('svg')
                    .attr('id', 'bar')
                    .attr('width', svgWidth)
                    .attr('height', svgHeight)
                    .attr('transform', translate(margin.left, margin.top))
                    .append('g')
                        .attr('transform', translate(margin.left, margin.top));

    // Update functions
    // Table
    function updateTable(data, year, init){
        let currentData = getSelectedData(data, year);

        let tableContents = d3.select('#table')
                            .append('g')
                            .attr('transform', translate(margin.left, margin.top))
                            .attr('class', 'content-group')
                            .selectAll('g')
                            .data(currentData.rankings)
                            .enter()
                            .append('g')
                            .attr('class', 'content-list')
                            .attr('transform', (d, i) =>{
                                return translate(0, tableRectHeight * (i+2))
                            }) 
        let tableData = d3.selectAll('.content-list')
                                .selectAll('g')
                                .data(d => {
                                    return [
                                        d.rank,
                                        d.team,
                                        d.W,
                                        d.D,
                                        d.L,
                                        d.win_rate,
                                        d.diff_game
                                    ];
                                })
                                .enter()
                                .append('g')
                                .attr('transform', (d, i) =>{
                                    return translate(tableRectWidth * i, 0)
                                });;

        if (! init){
            d3.selectAll('.content-list')
                .selectAll('text')
                .data(currentData)
                .exit()
                .transition()
                .duration(500)
                .style('opacity', '0')
                .remove();
        }            
        let tableRect = tableData                        
                                .append('rect')
                                .attr('width', tableRectWidth)
                                .attr('height', tableRectHeight)
                                .attr('fill', 'none')
                                                                        
        if(!init){
            let tableText = tableData.append('text')
                                    .text(x => x)
                                    .attr('opacity', 0)
                                    .transition()
                                    .delay(500)
                                    .duration(500)
                                    .attr('opacity', 1)
        }
        else{
            let tableText = tableData.append('text')
                                    .text(x => x)
        }
    }

    function preprocessData(data, currentData){
        let currentTeam = [];
        let chartData = [];

        for(let i=0; i<currentData['rankings'].length; i++){
            currentTeam.push(currentData['rankings'][i].team)
        }

        for(let i=0; i<currentTeam.length;i++){
            let temp = {'team': currentTeam[i], 'value': []};
            chartData.push(temp);    
        }

        for(let i=0; i<data.length;i++){
            for(let j=0; j<data[i].rankings.length;j++){
                for(let k=0; k<chartData.length; k++){
                    if (chartData[k].team === data[i].rankings[j].team){
                        let tempDict = {'year': data[i].year, 
                                        'win_rate': data[i].rankings[j].win_rate,
                                        'diff_game': data[i].rankings[j].diff_game,
                                        'W': data[i].rankings[j].W,
                                        'D': data[i].rankings[j].D,
                                        'L': data[i].rankings[j].L}
                        chartData[k].value.push(tempDict)
                    }
                }
            }
        }
        return [currentTeam, chartData];
    }

    // Line Chart
    function updateLine(data, year, win_diff, colorTeam, is_change, init){
        let currentData = getSelectedData(data, year);
        let tempData = preprocessData(data, currentData)
        currentTeam = tempData[0]
        chartData = tempData[1]

        if(win_diff == 'WR'){
            let chartWinRateX = d3.scaleLinear()
                        .domain([
                            d3.min(chartData, d=> {
                                return d3.min(d.value, datum => {
                                    return datum.year;
                                })
                            }),
                            d3.max(chartData, d=> {
                                return d3.max(d.value, datum => {
                                    return datum.year;
                                })
                            })
                        ])
                        .range([40, width])

            let chartWinRateY = d3.scaleLinear()
                        .domain([
                            d3.min(chartData, d => {
                                return d3.min(d.value, datum => {
                                    return datum.win_rate;
                                })
                            }),
                            d3.max(chartData, d => {
                                return d3.max(d.value, datum => {
                                    return datum.win_rate;
                                })
                            })
                        ])
                        .range([height, 0])

            let lineD = d3.line()
                            .x(d => {return chartWinRateX(parseFloat(d.year))})
                            .y(d => {return chartWinRateY(d.win_rate)})

            let lineChart = d3.select('#line');

            if(init){
                let lines = lineChart.selectAll('path')
                    .data(chartData)
                    .enter()
                    .append('path')
                        .attr('class', d => 'chart-info ' + d.team)
                        .attr('d', d => lineD(d.value))
                        .attr('fill', 'none')
                        .attr('stroke', d => colorTeam[d.team])
                        .attr('stroke-width', '1.5')
            } 
            else{
                d3.selectAll('.chartAxis')
                .remove();
                
                d3.selectAll('.chart-info')
                    .data(chartData, d=> d.team)
                    .exit()
                    .remove();

                lineChart.selectAll('.chart-info')
                        .data(chartData, d => d.team)
                        .enter()
                        .append('path')
                            .attr('class', d => 'chart-info ' + d.team)
                            .attr('d', d => lineD(d.value))
                            .attr('fill', 'none')
                            .attr('stroke', d => colorTeam[d.team])
                            .attr('stroke-width', '1.5')
                            .attr('opacity', 0)
                            .transition()
                            .duration(500)
                            .attr('opacity', 1)
            }
            if(is_change){
                lineChart.selectAll('.chart-info')
                        .transition().duration(500)
                        .attr('d', d => lineD(d.value))
                        .attr('fill', 'none')
                        .attr('stroke', d => colorTeam[d.team])
                        .attr('stroke-width', '1.5')
            }
            lineChart.append('g')
                        .call(d3.axisBottom(chartWinRateX))
                        .attr('class', 'chartAxis')
                        .attr('transform', translate(0, height))

            lineChart.append('g')
                        .call(d3.axisLeft(chartWinRateY))
                        .attr('class', 'chartAxis')
                        .attr('transform', translate(40, 0)) 
            }
        else if (win_diff == 'DG'){
            let chartDiffGameX = d3.scaleLinear()
                        .domain([
                            d3.min(chartData, d=> {
                                return d3.min(d.value, datum => {
                                    return datum.year;
                                })
                            }),
                            d3.max(chartData, d=> {
                                return d3.max(d.value, datum => {
                                    return datum.year;
                                })
                            })
                        ])
                        .range([40, width])

            let chartDiffGameY = d3.scaleLinear()
                        .domain([
                            d3.max(chartData, d => {
                                return d3.max(d.value, datum => {
                                    return datum.diff_game;
                                })
                            }),
                            d3.min(chartData, d => {
                                return d3.min(d.value, datum => {
                                    return datum.diff_game;
                                })
                            })
                            
                        ])
                        .range([height, 0])

            let lineD = d3.line()
                            .x(d => {return chartDiffGameX(parseFloat(d.year))})
                            .y(d => {return chartDiffGameY(d.diff_game)})

            let lineChart = d3.select('#line');
                            
            lineChart
                .selectAll('.chart-info')
                .data(chartData, d => d.team)
                .exit()
                .remove();

            d3.selectAll('.chartAxis')
                .remove();

            if(is_change){
                lineChart.selectAll('.chart-info')
                        .transition().duration(500)
                        .attr('d', d => lineD(d.value))
                        .attr('fill', 'none')
                        .attr('stroke', d => colorTeam[d.team])
                        .attr('stroke-width', '1.5')
            }
            else{
                d3.selectAll('.chart-info')
                    .data(chartData, d=> d.team)
                    .exit()
                    .remove();

                lineChart.selectAll('.chart-info')
                        .data(chartData, d => d.team)
                        .enter()
                        .append('path')
                            .attr('class', d => 'chart-info ' + d.team)
                            .attr('d', d => lineD(d.value))
                            .attr('fill', 'none')
                            .attr('stroke', d => colorTeam[d.team])
                            .attr('stroke-width', '1.5')
                            .attr('opacity', 0)
                            .transition()
                            .duration(500)
                            .attr('opacity', 1)
            }

            lineChart.append('g')
                        .call(d3.axisBottom(chartDiffGameX))
                        .attr('class', 'chartAxis')
                        .attr('transform', translate(0, height))

            lineChart.append('g')
                        .call(d3.axisLeft(chartDiffGameY))
                        .attr('class', 'chartAxis')
                        .attr('transform', translate(40, 0)) 
        }
    }

    // Bar chart
    function updateBar(data, year, WDL, colorTeam, clickChange){
        let currentData = getSelectedData(data, year);
        let tempData = preprocessData(data, currentData)
        let currentTeam = tempData[0]
        let chartData = tempData[1]

        let barX = d3.scaleBand()
                        .domain(currentTeam)
                        .rangeRound([0, width]);
                        
        let barY = d3.scaleLinear()
                        .domain([
                            0,
                            d3.max(currentData.rankings, d => {
                                if (WDL === 'W'){return d.W;}
                                else if (WDL === 'D') {return d.D}
                                else {return d.L}
                                })
                        ])
                        .range([height, 0]);
        
        let barXAxis = d3.axisBottom(barX);
        let barYAxis = d3.axisLeft(barY);

        d3.selectAll('.barAxis').remove();

        barSVG.append('g')
            .attr('transform', translate(0, height))
            .attr('class', 'barAxis')
            .call(barXAxis)
        barSVG.append('g')
            .attr('transform', translate(0,0))
            .attr('class', 'barAxis')
            .call(barYAxis)

        let bar = barSVG.selectAll('rect')
                    .data(currentData.rankings, d => d.team)

        if(clickChange){
            bar.transition()
                .duration(500)
                .attr('x', d => barX(d.team))
                .attr('y', d => {if(WDL === 'W'){return barY(d.W);}
                                    else if(WDL === 'D'){return barY(d.D);}
                                    else{return barY(d.L);}})
                .attr('width', barX.bandwidth())
                .attr('height', d => {if(WDL === 'W'){return height - barY(d.W);}
                                    else if(WDL === 'D'){return height - barY(d.D);}
                                    else{return height - barY(d.L);}})
                .style('fill', d => colorTeam[d.team])
        }
        else{
            bar.enter()
            .append('rect')
            .merge(bar)
            .attr('x', d => barX(d.team))
            .attr('y', d => {if(WDL === 'W'){return barY(d.W);}
                                else if(WDL === 'D'){return barY(d.D);}
                                else{return barY(d.L);}})
            .attr('width', barX.bandwidth())
            .attr('height', d => {if(WDL === 'W'){return height - barY(d.W);}
                                else if(WDL === 'D'){return height - barY(d.D);}
                                else{return height - barY(d.L);}})
            .style('fill', d => colorTeam[d.team])
        }
                
    }

    d3.json('data.json').then(function(data){
        let uniqueTeam = [];
        let colorTeam = new Object();

        data.forEach(function(d){
            d.rankings.forEach(function(d2){
                d2.rank = parseFloat(d2.rank);
                d2.games = parseFloat(d2.games);
                d2.W = parseFloat(d2.W);
                d2.L = parseFloat(d2.L);
                d2.D = parseFloat(d2.D);
                d2.diff_game = parseFloat(d2.diff_game);
                d2.win_rate = parseFloat(d2.win_rate);
                uniqueTeam.push(d2.team);
            })
        })

        uniqueTeam = [... new Set(uniqueTeam)];
        for(let i=0; i<uniqueTeam.length; i++){
            colorTeam[uniqueTeam[i]] = '#'+Math.floor(Math.random()*16777215).toString(16);
        }

        let year_selection = d3.select('.years')
                                .selectAll('option')
                                    .data(data)
                                    .join('option')
                                    .text(k => k.year)
                                    .attr('id', k=> k.year)

        let currentData = getSelectedData(data, '1982');
        
        let tableTitle = table.append('g')
                        .attr('class', 'title-group')
                        .selectAll('text')
                        .data(['rank','team','W','D','L','win_rate','diff_game'])
                        .enter()
                        .append('g')
                        .attr('class', 'title')
                        .attr('transform', translate(margin.left, margin.top))

        let tableTitleRect = tableTitle.append('rect')
            .attr('width', tableRectWidth)
            .attr('height', tableRectHeight)
            .attr('fill', 'none')
            .attr('transform', (d, i) =>{
                return translate(tableRectWidth * i, height)
            }) 

        let tableTitleTexts = tableTitle.append('text')
                            .text(x => x)
                            .attr('transform', (d, i) => {
                                return translate(tableRectWidth * i, tableRectHeight)      
                            })                          


        // run
        updateTable(data, '1982', init=true);
        updateLine(data, '1982', 'WR', colorTeam, 
                        is_change=false, init=true);
        updateBar(data, '1982', WDL='W', colorTeam, clickChange=false);

        d3.select('.years')
            .on("change", function(d){
                let year = d3.select('.years').node().value;
                let win_diff = d3.select('.win_diff').node().value;
                currentData = getSelectedData(data, year);
                updateTable(data, year, init=false);
                updateLine(data, year, win_diff, colorTeam, 
                                is_change=false, init=false);
            })

        d3.select('.win_diff')
            .on('change', function(d){
                let year = d3.select('.years').node().value;
                let win_diff = d3.select('.win_diff').node().value;
                updateLine(data, year, win_diff, colorTeam, 
                                is_change=true, init=false);
            })
        d3.select('.WDL')
            .on('change', function(d){
                let year = d3.select('.years').node().value;
                let wdl = d3.select('.WDL').node().value;
                updateBar(data, year, WDL=wdl, colorTeam, clickChange=true)
            })
    })
    </script>
</body>
</html>
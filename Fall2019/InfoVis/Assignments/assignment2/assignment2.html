<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Assignment 2</title>
    <script src="https://d3js.org/d3.v5.js"></script>
    <style>
        select{display: block;}
    </style>
</head>
<body>
    <div id="plot">
        <select class="years"></select>
        <select class="win_diff">
            <option id="WR">WR</option>
            <option id="DG">DG</option>
        </select>
        <select class="WDL">
            <option id="W">W</option>
            <option id="D">D</option>
            <option id="L">L</option>
        </select>
    </div>

    <script>
    function translate(plotX, plotY){
        return 'translate(' + plotX + ', ' + plotY + ')';
    }   

    function getSelectedData(data, year) {
        for (var i = 0; i < data.length; i++) {
            var currentData = data[i];
            if (currentData.year === year) {
                return currentData;
            } 
        }
    }

    function appendRect(table, height){
        table.append('rect')
            .attr('width', tableRectWidth)
            .attr('height', tableRectHeight)
            .attr('fill', 'none')
            .attr('transform', (d, i) =>{
                return translate(tableRectWidth * i, height)
            }) 
    }

    function updateTable(currentData, init){
        if (! init){
            d3.selectAll('.content-list')
                .selectAll('text')
                .transition()
                .duration(500)
                .style('opacity', '0')
                .remove();
        }
        let tableContents = d3.select('#table')
                            .append('g')
                            .attr('transform', translate(margin.left, margin.top))
                            .attr('class', 'content-group')
                            .selectAll('g')
                            .data(currentData.rankings)
                            .enter()
                            .append('g')
                            .attr('class', 'content-list')
                            .attr('transform', (d, i) =>{
                                return translate(0, tableRectHeight * (i+2))
                            }) 
        // g
        let tableData = d3.selectAll('.content-list')
                                .selectAll('g')
                                .data(d => {
                                    return [
                                        d.rank,
                                        d.team,
                                        d.W,
                                        d.D,
                                        d.L,
                                        d.win_rate,
                                        d.diff_game
                                    ];
                                })
                                .enter()
                                .append('g')
                                .attr('transform', (d, i) =>{
                                    return translate(tableRectWidth * i, 0)
                                });;

        // rect                        
        let tableRect = tableData                        
                                .append('rect')
                                .attr('width', tableRectWidth)
                                .attr('height', tableRectHeight)
                                .attr('fill', 'none')
                                                                        
        if(!init){
            let tableText = tableData.append('text')
                                    .text(x => x)
                                    .attr('opacity', 0)
                                    .transition()
                                    .delay(500)
                                    .duration(500)
                                    .attr('opacity', 1)
        }
        else{
            let tableText = tableData.append('text')
                                    .text(x => x)
        }
    }

    let svgWidth = 450;
    let svgHeight = 400;
    let tableRectWidth = 60;
    let tableRectHeight = 30;
    let margin = {top: 40, right: 10, bottom: 30, left: 20};
    let width = svgWidth - margin.left - margin.right;
    let height = svgHeight - margin.top - margin.bottom;

    d3.json('data.json').then(function(data){
        let uniqueTeam = [];
        let colorTeam = [];
        let years = []

        data.forEach(function(d){
            d.rankings.forEach(function(d2){
                d2.rank = parseFloat(d2.rank);
                d2.games = parseFloat(d2.games);
                d2.W = parseFloat(d2.W);
                d2.L = parseFloat(d2.L);
                d2.D = parseFloat(d2.D);
                d2.diff_game = parseFloat(d2.diff_game);
                d2.win_rate = parseFloat(d2.win_rate);
                uniqueTeam.push(d2.team);
            })
            d.year = parseFloat(d.year)
            years.push(d.year)
        })

        uniqueTeam = [... new Set(uniqueTeam)];
        for(let i=0; i<uniqueTeam.length; i++){colorTeam.push('#'+Math.floor(Math.random()*16777215).toString(16)) }

        let year_selection = d3.select('.years')
                                .selectAll('option')
                                    .data(data)
                                    .join('option')
                                    .text(k => k.year)
                                    .attr('id', k=> k.year)

        let currentData = getSelectedData(data, 1982);

        let table = d3.select('#plot')
                        .append('svg')
                        .attr('id', 'table')
                        .attr('width', svgWidth)
                        .attr('height', svgHeight)
        
        let tableTitle = table.append('g')
                        .attr('class', 'title-group')
                        .selectAll('text')
                        .data(['rank','team','W','D','L','win_rate','diff_game'])
                        .enter()
                        .append('g')
                        .attr('class', 'title')
                        .attr('transform', translate(margin.left, margin.top))

        let tableTitleRect = appendRect(tableTitle, 0)

        let tableTitleTexts = tableTitle.append('text')
                            .text(x => x)
                            .attr('transform', (d, i) => {
                                return translate(tableRectWidth * i, tableRectHeight)      
                            })

        // line chart
        let chartData = [];
        for(let i=0; i<uniqueTeam.length;i++){
            let temp = {'team': uniqueTeam[i], 'value': []};
            chartData.push(temp);
        }

        for(let i=0; i<data.length;i++){
            for(let j=0; j<data[i].rankings.length;j++){
                for(let k=0; k<chartData.length; k++){
                    if (chartData[k].team === data[i].rankings[j].team){
                        let tempDict = {'year': data[i].year, 
                                        'win_rate': data[i].rankings[j].win_rate}
                        chartData[k].value.push(tempDict)
                    }
                }
            }
        }

        let lineChart = d3.select('#plot')
                            .append('svg');
        lineChart.attr('id', 'chart')
                    .attr('width', svgWidth)
                    .attr('height', svgHeight)
                            
        var chartX = d3.scaleLinear()
                    .domain([
                        d3.min(years),
                        d3.max(years)
                    ])
                    .range([0, width])

        var chartY = d3.scaleLinear()
                        .domain([
                            d3.min(chartData, d => {
                                return d3.min(d.value, datum => {
                                    return datum.win_rate;
                                })
                            }),
                            d3.max(chartData, d => {
                                return d3.max(d.value, datum => {
                                    return datum.win_rate;
                                })
                            })
                        ])

        lineChart.append('g')
                    .call(chartX)
        lineChart.append('g')
                    .call(chartY)

        let line = d3.line()
                        .x(d => chartX(d.year))
                        .y(d => chartY(d.win_rate))


        console.log(lineChart);

        // var chartY = d3.scaleLinear()
        //             .domain([
        //                 d3.min(years),
        //                 d3.max(years)
        //             ])

                 

        // histogram


        // run
        updateTable(currentData, true);

        d3.select('.years')
            .on("change", function(d){
                let selected = parseFloat(d3.select('.years').node().value);
                currentData = getSelectedData(data, selected);
                updateTable(currentData, false);
                ;
            })
        

    })
    </script>
</body>
</html>